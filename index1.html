<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥n qu√† ƒë·∫∑c bi·ªát</title>
    <!-- Th∆∞ vi·ªán Three.js ƒë·ªÉ v·∫Ω 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ---- General Styling ---- */
        body {
            margin: 0;
            font-family: 'Playpen Sans', cursive;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
        }

        /* ---- Page Switching Logic ---- */
        .page {
            display: none;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .page.active {
            display: flex;
        }
        
        /* ---- Password Page ---- */
        #password-page {
            background-color: #f0f0f0;
        }
        
        .container {
            text-align: center;
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-family: 'Playpen Sans', cursive;
            color: rgb(0, 0, 0);
            font-size: 32px;
            margin-bottom: 30px;
            text-shadow: 0 4px 4px rgba(145, 145, 145, 0.7);
        }

        .password-wrapper {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .password-image {
            width: 150px;
            height: 150px;
            background-color: #f5f5f5;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
        }

        .password-image img {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            object-fit: cover;
            display: none; /* ·∫®n cho ƒë·∫øn khi load xong */
        }

        .password-image img.loaded {
            display: block;
        }

        .placeholder-text {
            color: #999;
            font-size: 14px;
            text-align: center;
        }

        .password-input-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #password-display {
            width: 100%;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 30px;
            letter-spacing: 10px;
            text-align: center;
            line-height: 40px;
            color: #333;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .keypad button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .keypad button:hover {
            background-color: #e0e0e0;
        }

        .keypad button:active {
            transform: scale(0.95);
        }

        #status-message {
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            height: 20px;
        }

        /* ---- Birthday Page ---- */
        #birthday-page {
            position: relative;
        }
        
        #matrix-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .greeting-container {
            position: relative;
            z-index: 2;
            color: white;
            font-size: 8vw;
            font-weight: bold;
            text-shadow: 0 0 15px #fff, 0 0 25px #fff;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            position: absolute;
        }

        .greeting-container.visible {
            opacity: 1;
        }
        
        .gift-container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            visibility: hidden;
        }

        .gift-container.visible {
            opacity: 1;
            visibility: visible;
        }

        .gift-container img {
            width: 250px;
            height: 250px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.7);
        }

        .gift-container button {
            font-family: 'Playpen Sans', cursive;
            padding: 15px 30px;
            font-size: 20px;
            border: none;
            border-radius: 50px;
            background-color: #ff69b4;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 20px #ff69b4;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gift-container button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px #ff69b4;
        }
        
        /* ---- Galaxy Page ---- */
        #galaxy-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #galaxy-canvas:active {
            cursor: grabbing;
        }

        .galaxy-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            max-width: 200px;
        }

        .control-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-icon {
            font-size: 16px;
            width: 20px;
        }

        /* Error message styling */
        .error-message {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- ======================= PAGE 1: M·∫¨T KH·∫®U ======================= -->
    <div id="password-page" class="page active">
        <div class="container">
            <h1>NH·∫¨P PASS ƒêI NG∆Ø·ªúI ƒê·∫∏P</h1>
            <div class="password-wrapper">
                <div class="password-image">
                    <img id="girl-img-1" alt="Cute Girl">
                    <div class="placeholder-text" id="img-placeholder-1">
                        ƒêang t·∫£i ·∫£nh...<br>
                        <small>ƒê·∫∑t file 1.png trong c√πng th∆∞ m·ª•c</small>
                    </div>
                </div>
                <div class="password-input-area">
                    <div id="password-display"></div>
                    <div class="keypad">
                        <button>1</button><button>2</button><button>3</button>
                        <button>4</button><button>5</button><button>6</button>
                        <button>7</button><button>8</button><button>9</button>
                        <button id="submit">‚úî</button><button>0</button><button id="delete">‚å´</button>
                    </div>
                    <div id="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= PAGE 2: CH√öC M·ª™NG ======================= -->
    <div id="birthday-page" class="page">
        <canvas id="matrix-canvas"></canvas>
        <div id="greeting1" class="greeting-container">Ch√∫c m·ª´ng</div>
        <div id="greeting2" class="greeting-container">sinh nh·∫≠t</div>
        <div id="greeting3" class="greeting-container">b·∫°n y√™u</div>
        <div id="gift" class="gift-container">
            <img id="girl-img-2" alt="Gift">
            <button id="gift-button">Qu√† n√®</button>
        </div>
    </div>

    <!-- ======================= PAGE 3: V≈® TR·ª§ ======================= -->
    <div id="galaxy-page" class="page">
         <canvas id="galaxy-canvas"></canvas>
         <!-- <div class="galaxy-controls">
            <div style="font-weight: bold; margin-bottom: 10px; color: #ff69b4;">üéÆ ƒêi·ªÅu khi·ªÉn</div>
            <div class="control-item">
                <span class="control-icon">üñ±Ô∏è</span>
                <span>K√©o ƒë·ªÉ xoay</span>
            </div>
            <div class="control-item">
                <span class="control-icon">üîÑ</span>
                <span>Cu·ªôn ƒë·ªÉ zoom</span>
            </div>
            <div class="control-item">
                <span class="control-icon">üì±</span>
                <span>Touch: 1 ng√≥n xoay, 2 ng√≥n zoom</span>
            </div>
            <div class="control-item">
                <span class="control-icon">üéÜ</span>
                <span>Ph√°o hoa li√™n t·ª•c</span>
            </div>
         </div> -->
    </div>

    <script>
        // --- C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N ·∫¢NH ---
        const imagePaths = [
            '1.png',                    // Th·ª≠ file trong c√πng th∆∞ m·ª•c
            './1.png',                  // Th·ª≠ v·ªõi ./
            './img/1.png',              // Th·ª≠ trong th∆∞ m·ª•c img
            'img/1.png',                // Th·ª≠ img/ m√† kh√¥ng c√≥ ./
            '../1.png',                 // Th·ª≠ th∆∞ m·ª•c cha
            'https://picsum.photos/200/200?random=1', // ·∫¢nh demo n·∫øu kh√¥ng t√¨m th·∫•y
        ];

        // Bi·∫øn global ƒë·ªÉ l∆∞u texture ƒë√£ t·∫£i th√†nh c√¥ng
        let globalTexture = null;

        // H√†m t·∫£i ·∫£nh v·ªõi fallback (cho HTML img)
        function loadImageWithFallback(imgElement, placeholderElement, paths, index = 0) {
            if (index >= paths.length) {
                // N·∫øu kh√¥ng t√¨m th·∫•y ·∫£nh n√†o, hi·ªÉn th·ªã placeholder
                if (placeholderElement) {
                    placeholderElement.innerHTML = `
                        ‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh!<br>
                        <small style="color: #666;">
                            H√£y ƒë·∫∑t file "1.png" v√†o:<br>
                            - C√πng th∆∞ m·ª•c v·ªõi file HTML<br>
                            - Ho·∫∑c trong th∆∞ m·ª•c "img/"
                        </small>
                    `;
                }
                return;
            }

            const currentPath = paths[index];
            const testImg = new Image();
            
            testImg.onload = function() {
                // ·∫¢nh t·∫£i th√†nh c√¥ng
                imgElement.src = currentPath;
                imgElement.classList.add('loaded');
                if (placeholderElement) {
                    placeholderElement.style.display = 'none';
                }
                console.log(`‚úÖ ƒê√£ t·∫£i ·∫£nh t·ª´: ${currentPath}`);
                
                // ƒê·ªìng th·ªùi t·∫°o texture cho Three.js
                createGlobalTexture(currentPath);
            };
            
            testImg.onerror = function() {
                // ·∫¢nh l·ªói, th·ª≠ ƒë∆∞·ªùng d·∫´n ti·∫øp theo
                console.log(`‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh t·∫°i: ${currentPath}`);
                loadImageWithFallback(imgElement, placeholderElement, paths, index + 1);
            };
            
            testImg.src = currentPath;
        }

        // T·∫°o global texture t·ª´ ·∫£nh ƒë√£ t·∫£i th√†nh c√¥ng
        function createGlobalTexture(imagePath) {
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(
                imagePath,
                function(texture) {
                    globalTexture = texture;
                    console.log('‚úÖ ƒê√£ t·∫°o global texture cho Galaxy');
                },
                undefined,
                function(error) {
                    console.log('‚ùå Kh√¥ng th·ªÉ t·∫°o texture t·ª´ ·∫£nh ƒë√£ t·∫£i');
                    createFallbackTexture();
                }
            );
        }

        // T·∫°o texture thay th·∫ø khi kh√¥ng c√≥ ·∫£nh
        function createFallbackTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            // T·∫°o gradient ƒë·∫πp
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, '#ff69b4');
            gradient.addColorStop(0.5, '#9c27b0');
            gradient.addColorStop(1, '#673ab7');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);
            
            // Th√™m text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üíñ', 32, 20);
            ctx.font = '8px Arial';
            ctx.fillText('BIRTHDAY', 32, 35);
            ctx.fillText('GIFT', 32, 45);
            
            globalTexture = new THREE.CanvasTexture(canvas);
            console.log('‚úÖ ƒê√£ t·∫°o fallback texture');
        }

        // T·∫£i ·∫£nh cho c·∫£ hai trang
        const img1 = document.getElementById('girl-img-1');
        const img2 = document.getElementById('girl-img-2');
        const placeholder1 = document.getElementById('img-placeholder-1');
        
        loadImageWithFallback(img1, placeholder1, imagePaths);
        loadImageWithFallback(img2, null, imagePaths);

        // --- LOGIC CHUY·ªÇN TRANG ---
        let matrixInterval;
        let galaxyAnimationId;

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'birthday-page') {
                initBirthdayPage();
            } else if (pageId === 'galaxy-page') {
                if (matrixInterval) clearInterval(matrixInterval);
                if (galaxyAnimationId) cancelAnimationFrame(galaxyAnimationId);
                initGalaxyPage();
            }
        }

        // --- LOGIC TRANG M·∫¨T KH·∫®U ---
        (function setupPasswordPage() {
            const passwordDisplay = document.getElementById('password-display');
            const statusMessage = document.getElementById('status-message');
            const keypadButtons = document.querySelectorAll('#password-page .keypad button');
            const correctPassword = '111111';
            let enteredPassword = '';

            keypadButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const key = button.textContent;
                    if (key === '‚úî') {
                        checkPassword();
                    } else if (key === '‚å´') {
                        enteredPassword = enteredPassword.slice(0, -1);
                        updateDisplay();
                    } else if (enteredPassword.length < 6) {
                        enteredPassword += key;
                        updateDisplay();
                    }
                });
            });

            function updateDisplay() {
                passwordDisplay.textContent = '‚Ä¢'.repeat(enteredPassword.length);
            }

            function checkPassword() {
                if (enteredPassword === correctPassword) {
                    statusMessage.textContent = 'Ch√≠nh X√°c!';
                    statusMessage.style.color = 'green';
                    setTimeout(() => {
                        switchPage('birthday-page');
                    }, 1000);
                } else {
                    statusMessage.textContent = 'Sai r·ªìi! Th·ª≠ l·∫°i ƒëi!';
                    statusMessage.style.color = 'red';
                    enteredPassword = '';
                    setTimeout(() => {
                        updateDisplay();
                        statusMessage.textContent = '';
                    }, 1500);
                }
            }
        })();

        // --- LOGIC TRANG SINH NH·∫¨T ---
        function initBirthdayPage() {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const letters = 'HAPPYBIRTHDAY';
            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);

            function drawMatrix() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#9c27b0';
                ctx.font = `${fontSize}px monospace`;
                for (let i = 0; i < drops.length; i++) {
                    const text = letters.charAt(Math.floor(Math.random() * letters.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            matrixInterval = setInterval(drawMatrix, 40);

            const greeting1 = document.getElementById('greeting1');
            const greeting2 = document.getElementById('greeting2');
            const greeting3 = document.getElementById('greeting3');
            const giftContainer = document.getElementById('gift');

            setTimeout(() => { greeting1.classList.add('visible'); }, 500);
            setTimeout(() => { greeting1.classList.remove('visible'); }, 3000);
            setTimeout(() => { greeting2.classList.add('visible'); }, 3500);
            setTimeout(() => { greeting2.classList.remove('visible'); }, 6000);
            setTimeout(() => { greeting3.classList.add('visible'); }, 6500);
            setTimeout(() => {
                greeting3.classList.remove('visible');
                clearInterval(matrixInterval); 
                canvas.style.transition = 'opacity 1s';
                canvas.style.opacity = '0';
            }, 9000);
            setTimeout(() => { giftContainer.classList.add('visible'); }, 10000);

            document.getElementById('gift-button').onclick = () => switchPage('galaxy-page');
        }

        // --- LOGIC TRANG V≈® TR·ª§ ---
        function initGalaxyPage() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            const renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('galaxy-canvas'), 
                antialias: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            camera.position.z = 100;

            // ===== BI·∫æN ƒêI·ªÄU KHI·ªÇN =====
            let cameraDistance = 100;
            let cameraAngleX = 0;
            let cameraAngleY = 0;
            let isMouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            let fireworks = [];
            let fireworksSchedule = []; // L·ªãch tr√¨nh t·∫°o ph√°o hoa

            // ===== S·ª∞ KI·ªÜN CHU·ªòT =====
            const canvas = document.getElementById('galaxy-canvas');
            
            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isMouseDown) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    cameraAngleY += deltaX * 0.01;
                    cameraAngleX -= deltaY * 0.01;
                    
                    // Gi·ªõi h·∫°n g√≥c X
                    cameraAngleX = Math.max(-Math.PI/3, Math.min(Math.PI/3, cameraAngleX));
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            // Zoom b·∫±ng b√°nh xe chu·ªôt
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                cameraDistance += e.deltaY * 0.1;
                cameraDistance = Math.max(50, Math.min(300, cameraDistance));
            });

            // Touch events cho mobile
            let touchDistance = 0;
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isMouseDown = true;
                    mouseX = e.touches[0].clientX;
                    mouseY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    touchDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
                e.preventDefault();
            });

            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isMouseDown) {
                    const deltaX = e.touches[0].clientX - mouseX;
                    const deltaY = e.touches[0].clientY - mouseY;
                    
                    cameraAngleY += deltaX * 0.01;
                    cameraAngleX -= deltaY * 0.01;
                    cameraAngleX = Math.max(-Math.PI/3, Math.min(Math.PI/3, cameraAngleX));
                    
                    mouseX = e.touches[0].clientX;
                    mouseY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    const newDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const deltaDistance = touchDistance - newDistance;
                    cameraDistance += deltaDistance * 0.3;
                    cameraDistance = Math.max(50, Math.min(300, cameraDistance));
                    touchDistance = newDistance;
                }
                e.preventDefault();
            });

            canvas.addEventListener('touchend', () => {
                isMouseDown = false;
            });

            // ===== L·ªöP FIREWORK C·∫¢I THI·ªÜN =====
            class Firework {
                constructor(x, y, z, type = 'normal') {
                    this.particles = [];
                    this.center = new THREE.Vector3(x, y, z);
                    this.age = 0;
                    this.maxAge = type === 'large' ? 4 : 3;
                    this.type = type;
                    
                    // T·∫°o c√°c h·∫°t ph√°o hoa v·ªõi nhi·ªÅu bi·∫øn th·ªÉ
                    let particleCount, colors, spreadFactor;
                    
                    switch (type) {
                        case 'large':
                            particleCount = 60 + Math.random() * 40;
                            colors = [0xff69b4, 0x00ff88, 0x0088ff, 0xff8800, 0x8800ff, 0xffffff, 0xff1493, 0x00ffff];
                            spreadFactor = 50;
                            break;
                        case 'small':
                            particleCount = 15 + Math.random() * 10;
                            colors = [0xffffff, 0xff69b4, 0x00ff88];
                            spreadFactor = 25;
                            break;
                        case 'heart':
                            particleCount = 30;
                            colors = [0xff69b4, 0xff1493, 0xff0080];
                            spreadFactor = 30;
                            break;
                        default:
                            particleCount = 35 + Math.random() * 25;
                            colors = [0xff69b4, 0x00ff88, 0x0088ff, 0xff8800, 0x8800ff, 0xffffff];
                            spreadFactor = 35;
                    }
                    
                    const baseColor = colors[Math.floor(Math.random() * colors.length)];
                    
                    for (let i = 0; i < particleCount; i++) {
                        let velocity;
                        
                        if (type === 'heart') {
                            // T·∫°o h√¨nh tr√°i tim
                            const t = (i / particleCount) * Math.PI * 2;
                            const heartX = 16 * Math.pow(Math.sin(t), 3);
                            const heartY = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                            velocity = new THREE.Vector3(heartX * 0.8, heartY * 0.8, (Math.random() - 0.5) * 10);
                        } else {
                            // T·∫°o v·∫≠n t·ªëc ng·∫´u nhi√™n theo h√¨nh c·∫ßu
                            const phi = Math.random() * Math.PI * 2;
                            const theta = Math.acos(2 * Math.random() - 1);
                            const speed = spreadFactor * (0.5 + Math.random() * 0.5);
                            
                            velocity = new THREE.Vector3(
                                Math.sin(theta) * Math.cos(phi) * speed,
                                Math.sin(theta) * Math.sin(phi) * speed,
                                Math.cos(theta) * speed
                            );
                        }
                        
                        const particle = {
                            position: this.center.clone(),
                            velocity: velocity,
                            life: 1.0,
                            decay: 0.015 + Math.random() * 0.02,
                            originalLife: 1.0,
                            size: type === 'large' ? 0.5 + Math.random() * 0.3 : 0.3 + Math.random() * 0.2,
                            twinkleSpeed: 5 + Math.random() * 10
                        };
                        
                        // T·∫°o sprite cho m·ªói h·∫°t v·ªõi hi·ªáu ·ª©ng ƒë·∫πp h∆°n
                        const geometry = new THREE.SphereGeometry(particle.size, 8, 8);
                        const material = new THREE.MeshBasicMaterial({ 
                            color: baseColor,
                            transparent: true,
                            opacity: 1.0
                        });
                        
                        particle.mesh = new THREE.Mesh(geometry, material);
                        particle.mesh.position.copy(particle.position);
                        scene.add(particle.mesh);
                        
                        this.particles.push(particle);
                    }
                    
                    // Th√™m hi·ªáu ·ª©ng √°nh s√°ng
                    this.light = new THREE.PointLight(baseColor, 3, 100);
                    this.light.position.copy(this.center);
                    scene.add(this.light);
                }
                
                update(deltaTime) {
                    this.age += deltaTime;
                    
                    // C·∫≠p nh·∫≠t √°nh s√°ng
                    if (this.light) {
                        this.light.intensity = Math.max(0, 3 * (1 - this.age / this.maxAge));
                        if (this.light.intensity <= 0.1) {
                            scene.remove(this.light);
                            this.light = null;
                        }
                    }
                    
                    this.particles = this.particles.filter(particle => {
                        // C·∫≠p nh·∫≠t v·ªã tr√≠
                        particle.position.add(particle.velocity.clone().multiplyScalar(deltaTime));
                        
                        // √Åp d·ª•ng ma s√°t v√† tr·ªçng l·ª±c
                        particle.velocity.multiplyScalar(0.985); // Ma s√°t kh√¥ng kh√≠
                        particle.velocity.y -= 25 * deltaTime; // Tr·ªçng l·ª±c
                        
                        // C·∫≠p nh·∫≠t life v·ªõi hi·ªáu ·ª©ng fade out m·ªÅm m·∫°i
                        particle.life -= particle.decay * deltaTime;
                        
                        // C·∫≠p nh·∫≠t mesh v·ªõi hi·ªáu ·ª©ng twinkle
                        particle.mesh.position.copy(particle.position);
                        
                        // Hi·ªáu ·ª©ng twinkle (l·∫•p l√°nh)
                        const twinkle = Math.sin(Date.now() * particle.twinkleSpeed * 0.001) * 0.3 + 0.7;
                        const fadeOpacity = Math.max(0, particle.life) * twinkle;
                        particle.mesh.material.opacity = fadeOpacity;
                        
                        // Hi·ªáu ·ª©ng scale theo th·ªùi gian
                        const scaleLife = Math.max(0.1, particle.life);
                        particle.mesh.scale.setScalar(scaleLife);
                        
                        if (particle.life <= 0) {
                            scene.remove(particle.mesh);
                            return false;
                        }
                        return true;
                    });
                    
                    return this.particles.length > 0 && this.age < this.maxAge;
                }
            }

            // ===== H·ªÜ TH·ªêNG QU·∫¢N L√ù PH√ÅO HOA C·∫¢I THI·ªÜN =====
            let fireworkTimer = 0;
            let nextFireworkTime = 0;
            const fireworkPatterns = [
                { interval: 0.8, type: 'normal', count: 1 },
                { interval: 1.2, type: 'small', count: 3 },
                { interval: 2.0, type: 'large', count: 1 },
                { interval: 1.5, type: 'heart', count: 1 },
                { interval: 0.5, type: 'small', count: 5 }, // Burst mode
            ];
            let currentPatternIndex = 0;

            // T·∫°o ph√°o hoa theo pattern
            function createFireworksByPattern(pattern) {
                for (let i = 0; i < pattern.count; i++) {
                    setTimeout(() => {
                        const x = (Math.random() - 0.5) * 300;
                        const y = 20 + Math.random() * 80;
                        const z = (Math.random() - 0.5) * 300;
                        fireworks.push(new Firework(x, y, z, pattern.type));
                    }, i * 100); // Delay nh·ªè gi·ªØa c√°c ph√°o hoa trong c√πng pattern
                }
            }

            // T·∫°o ph√°o hoa ƒë·∫∑c bi·ªát
            function createSpecialFireworks() {
                // T·∫°o v√≤ng tr√≤n ph√°o hoa
                const centerX = 0, centerY = 60, centerZ = 0;
                const radius = 80;
                const count = 8;
                
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const angle = (i / count) * Math.PI * 2;
                        const x = centerX + Math.cos(angle) * radius;
                        const z = centerZ + Math.sin(angle) * radius;
                        const y = centerY + (Math.random() - 0.5) * 20;
                        fireworks.push(new Firework(x, y, z, 'large'));
                    }, i * 150);
                }
            }

            // T·ª± ƒë·ªông t·∫°o ph√°o hoa ƒë·∫∑c bi·ªát m·ªói 15 gi√¢y
            setInterval(createSpecialFireworks, 15000);

            // N·ªÅn v≈© tr·ª• v·ªõi nhi·ªÅu sao
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 25000;
            const posArray = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 3000;
            }
            starGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const starMaterial = new THREE.PointsMaterial({ size: 1.2, color: 0xffffff });
            const starMesh = new THREE.Points(starGeometry, starMaterial);
            scene.add(starMesh);
            
            // √Ånh s√°ng m√†u
            const lightColors = [0x00ff88, 0xff0088, 0x0088ff, 0xff8800, 0x8800ff];
            const nebulaLights = [];
            lightColors.forEach((color, index) => {
                const light = new THREE.PointLight(color, 2, 800);
                const angle = (index / lightColors.length) * Math.PI * 2;
                light.position.set(
                    Math.cos(angle) * 200,
                    (Math.random() - 0.5) * 100,
                    Math.sin(angle) * 200
                );
                nebulaLights.push(light);
                scene.add(light);
            });

            // H√†nh tinh ch√≠nh
            const planet = new THREE.Mesh(
                new THREE.SphereGeometry(12, 64, 64),
                new THREE.MeshStandardMaterial({ 
                    color: 0xffa0e0, 
                    metalness: 0.3, 
                    roughness: 0.2, 
                    emissive: 0xff69b4, 
                    emissiveIntensity: 0.4 
                })
            );
            scene.add(planet);

            // V√≤ng bao quanh h√†nh tinh
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(18, 0.3, 8, 100),
                new THREE.MeshBasicMaterial({ 
                    color: 0xffffff, 
                    side: THREE.DoubleSide, 
                    transparent: true, 
                    opacity: 0.8 
                })
            );
            ring.rotation.x = Math.PI / 2.2;
            scene.add(ring);
            
            // M·∫∑t trƒÉng nh·ªè
            const moon = new THREE.Mesh(
                new THREE.SphereGeometry(3, 32, 32),
                new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x444444 })
            );
            scene.add(moon);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            // T·∫°o c√°c nh√≥m ·∫£nh s·ª≠ d·ª•ng globalTexture
            const imageGroups = [];
            const layers = [
                { count: 30, radius: 40, speed: 0.008, size: [6, 8] },
                { count: 40, radius: 70, speed: -0.005, size: [4, 6] },
                { count: 50, radius: 100, speed: 0.003, size: [3, 5] },
                { count: 35, radius: 130, speed: -0.002, size: [2, 4] },
                { count: 25, radius: 160, speed: 0.001, size: [2, 3] }
            ];

            // T·∫°o ·∫£nh v·ªõi delay ƒë·ªÉ ƒë·∫£m b·∫£o texture ƒë√£ s·∫µn s√†ng
            function createImageLayers() {
                const texture = globalTexture;
                if (!texture) {
                    console.log('‚è≥ Texture ch∆∞a s·∫µn s√†ng, t·∫°o fallback...');
                    createFallbackTexture();
                    return;
                }

                console.log('üåü ƒêang t·∫°o c√°c t·∫ßng ·∫£nh...');
                layers.forEach((layer, layerIndex) => {
                    const imageGroup = new THREE.Group();
                    
                    for (let i = 0; i < layer.count; i++) {
                        const material = new THREE.SpriteMaterial({ 
                            map: texture,
                            transparent: true,
                            opacity: 0.9
                        });
                        const sprite = new THREE.Sprite(material);
                        
                        const angle = (i / layer.count) * Math.PI * 2 + Math.random() * 0.5;
                        const radiusVariation = layer.radius + (Math.random() - 0.5) * 20;
                        const height = (Math.random() - 0.5) * 30;
                        
                        const x = Math.cos(angle) * radiusVariation;
                        const z = Math.sin(angle) * radiusVariation;
                        const y = height * (1 - Math.abs(radiusVariation - layer.radius) / 20);
                        
                        sprite.position.set(x, y, z);
                        
                        const scale = layer.size[0] + Math.random() * (layer.size[1] - layer.size[0]);
                        sprite.scale.set(scale, scale, scale);
                        
                        sprite.userData = {
                            originalOpacity: material.opacity,
                            twinkleSpeed: 0.5 + Math.random() * 2,
                            twinkleOffset: Math.random() * Math.PI * 2
                        };
                        
                        imageGroup.add(sprite);
                    }
                    
                    imageGroup.userData = { rotationSpeed: layer.speed };
                    imageGroups.push(imageGroup);
                    scene.add(imageGroup);
                });
                console.log(`‚úÖ ƒê√£ t·∫°o ${imageGroups.length} t·∫ßng ·∫£nh v·ªõi t·ªïng c·ªông ${imageGroups.reduce((sum, group) => sum + group.children.length, 0)} ·∫£nh`);
            }

            // Delay ƒë·ªÉ texture c√≥ th·ªùi gian t·∫£i
            setTimeout(createImageLayers, 1000);
            
            // V√≤ng tr√≤n g·∫°ch ƒë·ª©t
            const dashedRingGroup = new THREE.Group();
            const numDashes = 120;
            const dashRadius = 25;
            for (let i = 0; i < numDashes; i++) {
                if (i % 5 < 2) continue;
                const dashGeo = new THREE.BoxGeometry(0.8, 0.15, 0.15);
                const dashMat = new THREE.MeshBasicMaterial({ 
                    color: 0xffffff, 
                    transparent: true, 
                    opacity: 0.6 
                });
                const dash = new THREE.Mesh(dashGeo, dashMat);

                const angle = (i / numDashes) * Math.PI * 2;
                dash.position.set(Math.cos(angle) * dashRadius, 0, Math.sin(angle) * dashRadius);
                dash.lookAt(planet.position);
                dashedRingGroup.add(dash);
            }
            scene.add(dashedRingGroup);

            // Animation loop c·∫£i thi·ªán
            let clock = new THREE.Clock();
            function animate() {
                galaxyAnimationId = requestAnimationFrame(animate);
                const deltaTime = clock.getDelta();
                const elapsedTime = clock.getElapsedTime();
                
                // ===== QU·∫¢N L√ù PH√ÅO HOA TH√îNG MINH =====
                fireworkTimer += deltaTime;
                
                if (fireworkTimer >= nextFireworkTime) {
                    const currentPattern = fireworkPatterns[currentPatternIndex];
                    createFireworksByPattern(currentPattern);
                    
                    // C·∫≠p nh·∫≠t timing cho l·∫ßn t·∫°o ph√°o hoa ti·∫øp theo
                    nextFireworkTime = fireworkTimer + currentPattern.interval + (Math.random() - 0.5) * 0.5;
                    currentPatternIndex = (currentPatternIndex + 1) % fireworkPatterns.length;
                }
                
                // Animation c∆° b·∫£n
                planet.rotation.y += 0.003;
                ring.rotation.z += 0.002;
                dashedRingGroup.rotation.y += 0.004;
                
                // Animation m·∫∑t trƒÉng
                moon.position.x = Math.sin(elapsedTime * 0.7) * 25;
                moon.position.z = Math.cos(elapsedTime * 0.7) * 25;
                moon.position.y = Math.sin(elapsedTime * 0.3) * 5;
                
                // Animation c√°c t·∫ßng ·∫£nh (n·∫øu c√≥)
                imageGroups.forEach(group => {
                    group.rotation.y += group.userData.rotationSpeed;
                    
                    group.children.forEach(sprite => {
                        const twinkle = Math.sin(elapsedTime * sprite.userData.twinkleSpeed + sprite.userData.twinkleOffset);
                        sprite.material.opacity = sprite.userData.originalOpacity + twinkle * 0.3;
                    });
                });
                
                // Animation ƒë√®n nebula
                nebulaLights.forEach((light, index) => {
                    const angle = elapsedTime * 0.1 + (index * Math.PI * 2 / nebulaLights.length);
                    light.position.x = Math.cos(angle) * 200;
                    light.position.z = Math.sin(angle) * 200;
                    light.intensity = 1.5 + Math.sin(elapsedTime * 2 + index) * 0.5;
                });
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠ camera d·ª±a tr√™n t∆∞∆°ng t√°c ng∆∞·ªùi d√πng
                camera.position.x = Math.cos(cameraAngleY) * Math.cos(cameraAngleX) * cameraDistance;
                camera.position.y = Math.sin(cameraAngleX) * cameraDistance;
                camera.position.z = Math.sin(cameraAngleY) * Math.cos(cameraAngleX) * cameraDistance;
                camera.lookAt(scene.position);
                
                // C·∫≠p nh·∫≠t ph√°o hoa v·ªõi hi·ªáu su·∫•t t·ªëi ∆∞u
                fireworks = fireworks.filter(firework => firework.update(deltaTime));
                
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
</body>

</html>
